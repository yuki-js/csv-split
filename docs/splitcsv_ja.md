# CSV ファイル分割ツール仕様書

## 概要

CSV ファイル分割ツールは、大きな CSV ファイルをより管理しやすい小さなチャンクに分割するためのユーティリティツールです。これは、数百万行を含む CSV ファイルを標準ツールやアプリケーションで処理するのが難しい場合に特に有用です。

## 機能

- 大きな CSV ファイルを複数の小さなファイルに分割
- 各出力ファイルにヘッダ行を保持してデータの一貫性を維持
- 実際の CSV コンテンツに先行するメタデータヘッダを処理して破棄
- 単一ディレクトリ内の複数の CSV ファイルを処理
- 標準化された出力ファイル命名の作成

## 入出力仕様

### 入力

- **コマンドライン引数**: 1 つ以上の CSV ファイルを含むディレクトリパス
- **入力ファイル**: CSV ファイル（拡張子は `.csv` でなければならない）
  - 実際の CSV コンテンツに先行するオプションのメタデータヘッダを含む場合がある
  - コンマ区切りの値を含む少なくとも 1 行（ヘッダ行）を含む必要がある

### 出力

- **出力ディレクトリ**: 入力ディレクトリ内に `outs` という名前のサブディレクトリが作成される
- **出力ファイル**: `{original_name}_{sequence_number}.csv` パターンに従って命名された複数の CSV ファイル
  - シーケンス番号は 3 桁のゼロパディング（例: 001, 002, など）
  - 各ファイルには元のヘッダ行とデータ行のサブセットが含まれる
  - メタデータヘッダは出力ファイルに含まれない

## 動作詳細

### メタデータヘッダの処理

メタデータヘッダは、コンマを含まない行として定義されます。これらの行は処理中に破棄され、出力ファイルが標準の CSV 形式に準拠するようにします。

メタデータヘッダを含む入力の例:

```
メタデータ: これはサンプルのメタデータヘッダです
メタデータ: もう一つのメタデータヘッダ
id,name,age
1,John Doe,30
2,Jane Smith,25
```

出力の例:

```
id,name,age
1,John Doe,30
2,Jane Smith,25
```

### 分割アルゴリズム

1. メタデータヘッダを識別してスキップ（コンマを含まない行）
2. コンマを含む最初の行を CSV ヘッダとして識別
3. 最初の出力ファイルにヘッダを書き込む
4. データ行を読み続け、現在の出力ファイルに書き込む
5. 設定された行数に達した場合:
   - 現在のファイルを閉じる
   - インクリメントされたシーケンス番号で新しいファイルを作成
   - 新しいファイルにヘッダを書き込む
   - データ行を続ける
6. すべてのデータ行が処理されるまで繰り返す

### ファイルサイズの制御

- 各出力ファイル（最後のファイルを除く）は、ヘッダ行を含む `LINES_PER_FILE` データ行を正確に含む
- `LINES_PER_FILE` のデフォルト値は 100,000 ですが、設定で変更可能

## 実装ノート

### 主なコンポーネント

1. **コマンドラインインターフェース**: 引数を処理し、入力ディレクトリを検証
2. **ファイル検出**: 指定されたディレクトリ内の CSV ファイルを識別
3. **メタデータ検出**: メタデータヘッダを識別してスキップ
4. **分割処理**: ソースファイルを行ごとに読み取り、出力ファイルに書き込む
5. **出力管理**: 出力ディレクトリを作成し、ファイル命名を管理

### エラーハンドリング

実装は次のエラー条件を処理する必要があります:

- 入力ディレクトリが存在しない、または無効
- ディレクトリ内に CSV ファイルが見つからない
- ファイルの読み取りまたは書き込み中の I/O エラー

## 使用例

### 基本的な使用法

```
ts-node splitcsv.ts /path/to/csv/files
```

このコマンドは次のことを行います:

1. `/path/to/csv/files` 内の CSV ファイルを探す
2. `/path/to/csv/files/outs` に出力ディレクトリを作成
3. 各 CSV ファイルを 100,000 行ごとに分割
4. 出力ファイルを `{original_name}_{sequence_number}.csv` パターンに従って命名

## パフォーマンスの考慮事項

- 実装はメモリ使用量を最小限に抑えるために行ごとにファイルを処理
- ストリーミングを通じて大きなファイルを効率的に処理
- 信頼性のためにファイル操作は順次実行

## 拡張の可能性

ツールの潜在的な拡張には次のものが含まれます:

- 設定可能な出力ディレクトリ
- コマンドライン経由で調整可能な出力ファイルごとの行数
- カスタム出力ファイル命名パターン
- 埋め込みコンマを含む引用フィールドの高度な CSV 解析
- 複数の入力ファイルの並列処理
